#!/bin/bash
# Install notifykit locally
# Usage: ./scripts/install [--debug]
#
# This script:
# 1. Builds the app bundle using cargo-bundle
# 2. Signs the bundle (ad-hoc)
# 3. Copies it to ~/Applications
# 4. Creates a symlink in /usr/local/bin

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Check for cargo bundle
if ! cargo bundle --help &> /dev/null; then
    echo "cargo-bundle is not installed."
    read -p "Install cargo-bundle? [Y/n] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "Aborted. Install cargo-bundle manually with: cargo install cargo-bundle"
        exit 1
    fi
    cargo install cargo-bundle
fi

CARGO_FLAGS="-p notifykit"
PROFILE="release"
if [ "$1" = "--debug" ]; then
    PROFILE="debug"
else
    CARGO_FLAGS="$CARGO_FLAGS --release"
fi

# Build the bundle (must run from workspace root for resources to be included)
cd "$PROJECT_DIR"
cargo bundle $CARGO_FLAGS

APP_NAME="NotifyKit.app"
SOURCE_APP="$PROJECT_DIR/target/$PROFILE/bundle/osx/$APP_NAME"

# Verify bundle resources before installing
echo ""
echo "Verifying bundle resources..."
"$SCRIPT_DIR/verify-bundle-resources.sh" "$SOURCE_APP"

INSTALL_DIR="$HOME/Applications"
DEST_APP="$INSTALL_DIR/$APP_NAME"
BIN_DIR="/usr/local/bin"
BIN_LINK="$BIN_DIR/notifykit"

# Sign the app bundle (ad-hoc)
echo ""
echo "Signing bundle..."
codesign --sign - --force --deep "$SOURCE_APP"

echo ""
echo "Installing NotifyKit..."

# Create ~/Applications and install app bundle (remove old installation if present)
mkdir -p "$INSTALL_DIR"
rm -rf "$DEST_APP"
echo "Copying $APP_NAME to $INSTALL_DIR..."
cp -R "$SOURCE_APP" "$DEST_APP"

# Create symlink (may need sudo)
echo "Creating symlink at $BIN_LINK..."
if [ -w "$BIN_DIR" ]; then
    ln -sf "$DEST_APP/Contents/MacOS/notifykit" "$BIN_LINK"
else
    echo "Need sudo to create symlink in $BIN_DIR..."
    sudo mkdir -p "$BIN_DIR"
    sudo ln -sf "$DEST_APP/Contents/MacOS/notifykit" "$BIN_LINK"
fi

echo ""
echo "Installation complete!"
echo ""
echo "You can now use: notifykit send -t 'Title' -b 'Body' -s default"
echo ""
echo "Note: First run may require enabling notifications in:"
echo "  System Settings → Notifications → NotifyKit"

# Verify installation
echo ""
echo "Verifying installation..."
if command -v notifykit &> /dev/null; then
    echo ""
    notifykit --version
    echo ""
    echo "Installation verified successfully!"
else
    echo "Warning: notifykit not found in PATH"
    echo "You may need to restart your terminal or add /usr/local/bin to PATH"
fi
